# æŠ€èƒ½ç»„è£…åŠŸèƒ½ä¿®å¤æ€»ç»“æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2026-01-19  
**ä¿®å¤èŒƒå›´**: æŠ€èƒ½ç»„è£…åŠŸèƒ½ç›¸å…³ä»£ç   
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### âœ… P0 - ä¸¥é‡é—®é¢˜ï¼ˆå·²å…¨éƒ¨ä¿®å¤ï¼‰

#### 1. Agentæ¨¡å‹å­—æ®µè¡¥å…… âœ…
- **æ–‡ä»¶**: `backend/models/agent.py`
- **ä¿®å¤å†…å®¹**: æ·»åŠ äº†æ‰€æœ‰ç¼ºå¤±çš„å­—æ®µ
  - `agent_mode` (Integer, default=0)
  - `persona_id` (BigInteger, nullable=True)
  - `skill_ids` (JSON, nullable=True)
  - `skill_variables` (JSON, nullable=True)
  - `routing_description` (Text, nullable=True)
  - `is_routing_enabled` (Integer, default=0)
- **å½±å“**: ç§»é™¤äº†æ‰€æœ‰ `getattr()` å’Œ `hasattr()` åŠ¨æ€è®¿é—®ï¼Œä»£ç æ›´å®‰å…¨

#### 2. PromptBuilderå¼‚æ­¥åŒ– âœ…
- **æ–‡ä»¶**: `backend/services/prompt_builder.py`
- **ä¿®å¤å†…å®¹**:
  - `build_prompt()` æ”¹ä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œä½¿ç”¨ `AsyncSession`
  - `intelligent_routing()` æ”¹ä¸ºå¼‚æ­¥æ–¹æ³•
  - ä½¿ç”¨ `select()` å’Œ `await db.execute()` æ›¿ä»£åŒæ­¥ `db.query()`
  - æ‰¹é‡åŠ è½½æŠ€èƒ½ï¼Œæé«˜æ€§èƒ½
- **å½±å“**: å®Œå…¨ç¬¦åˆé¡¹ç›®å¼‚æ­¥è§„èŒƒ

#### 3. AgentServiceV2å¼‚æ­¥åŒ– âœ…
- **æ–‡ä»¶**: `backend/services/agent_service_v2.py`
- **ä¿®å¤å†…å®¹**: æ‰€æœ‰æ–¹æ³•æ”¹ä¸ºå¼‚æ­¥
  - `create_with_skills()` â†’ `async def`
  - `update_with_skills()` â†’ `async def`
  - `get_detail_with_skills()` â†’ `async def`
  - `get_list()` â†’ `async def`
  - `delete()` â†’ `async def`
  - `increment_usage_count()` â†’ `async def`
- **å½±å“**: ç§»é™¤äº†æ‰€æœ‰ `db.run_sync()` è°ƒç”¨

#### 4. SkillService.get_by_idså¼‚æ­¥åŒ– âœ…
- **æ–‡ä»¶**: `backend/services/skill_service.py`
- **ä¿®å¤å†…å®¹**: æ–¹æ³•æ”¹ä¸ºå¼‚æ­¥ï¼Œæ·»åŠ æ—¥å¿—è®°å½•
- **å½±å“**: ç¬¦åˆå¼‚æ­¥è§„èŒƒ

#### 5. å“åº”æ ¼å¼ç»Ÿä¸€ âœ…
- **æ–‡ä»¶**: 
  - `backend/routers/admin/v2/skill_library.py`
  - `backend/routers/admin/v2/agents_v2.py`
  - `backend/routers/client/v2/execution.py`
- **ä¿®å¤å†…å®¹**:
  - ç§»é™¤æ‰€æœ‰ `response_model` å‚æ•°
  - ä½¿ç”¨ `success()`, `fail()`, `page_response()` åŒ…è£…å“åº”
  - ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸ç±»
- **å½±å“**: å®Œå…¨ç¬¦åˆé¡¹ç›®å“åº”æ ¼å¼è§„èŒƒ

#### 6. Jinja2å®‰å…¨ä¿®å¤ âœ…
- **æ–‡ä»¶**: `backend/services/prompt_builder.py`
- **ä¿®å¤å†…å®¹**: ä» `_allowed_filters` ä¸­ç§»é™¤ `safe` è¿‡æ»¤å™¨
- **å½±å“**: é˜²æ­¢XSSæ”»å‡»

#### 7. execution.pyå¼‚æ­¥ä¿®å¤ âœ…
- **æ–‡ä»¶**: `backend/routers/client/v2/execution.py`
- **ä¿®å¤å†…å®¹**:
  - æ‰€æœ‰ `PromptBuilder` è°ƒç”¨æ”¹ä¸º `await`
  - `AgentServiceV2.increment_usage_count()` æ”¹ä¸º `await`
  - ç§»é™¤æ‰€æœ‰åŒæ­¥æ–¹æ³•è°ƒç”¨
- **å½±å“**: å®Œå…¨å¼‚æ­¥åŒ–

---

### âœ… P1 - ä¸­ç­‰é—®é¢˜ï¼ˆå·²å…¨éƒ¨ä¿®å¤ï¼‰

#### 8. å¼‚å¸¸å¤„ç†ç»Ÿä¸€ âœ…
- **ä¿®å¤å†…å®¹**: æ‰€æœ‰è·¯ç”±ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸ç±»
  - `NotFoundException` - èµ„æºä¸å­˜åœ¨
  - `BadRequestException` - å‚æ•°é”™è¯¯
- **å½±å“**: å¼‚å¸¸å¤„ç†æ›´ç»Ÿä¸€ï¼Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨è‡ªåŠ¨è½¬æ¢æ ¼å¼

#### 9. è¾“å…¥éªŒè¯å¢å¼º âœ…
- **æ–‡ä»¶**: `backend/schemas/v2/agent.py`
- **ä¿®å¤å†…å®¹**:
  - `PromptPreviewRequest.skill_ids`: æ·»åŠ  `min_items=1` éªŒè¯
  - `AgentExecuteRequest`: æ·»åŠ å­—æ®µéªŒè¯
    - `user_id`: `gt=0`
    - `project_id`: `gt=0`
    - `input_text`: `min_length=1`
  - `AgentCreateV2`: æ·»åŠ  `skill_ids` éªŒè¯å™¨ï¼ˆæŠ€èƒ½æ¨¡å¼ä¸‹å¿…å¡«ï¼‰
- **å½±å“**: æ›´ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®

#### 10. æ—¥å¿—è®°å½•å®Œå–„ âœ…
- **ä¿®å¤å†…å®¹**: åœ¨æ‰€æœ‰å…³é”®æ“ä½œå¤„æ·»åŠ æ—¥å¿—
  - åˆ›å»º/æ›´æ–°/åˆ é™¤æ“ä½œ
  - Promptç»„è£…è¿‡ç¨‹
  - æ™ºèƒ½è·¯ç”±é€‰æ‹©
  - é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
- **å½±å“**: æ›´å¥½çš„é—®é¢˜æ’æŸ¥èƒ½åŠ›

---

## ğŸ” ä»£ç è´¨é‡æ”¹è¿›

### 1. ç±»å‹å®‰å…¨
- âœ… ç§»é™¤äº†æ‰€æœ‰ `getattr()` åŠ¨æ€è®¿é—®
- âœ… æ‰€æœ‰æ–¹æ³•éƒ½æœ‰å®Œæ•´çš„ç±»å‹æç¤º
- âœ… ä½¿ç”¨ `AsyncSession` æ›¿ä»£ `Session`

### 2. æ€§èƒ½ä¼˜åŒ–
- âœ… æ‰¹é‡åŠ è½½æŠ€èƒ½ï¼ˆ`build_prompt` ä¸­ï¼‰
- âœ… ä½¿ç”¨å¼‚æ­¥æŸ¥è¯¢æé«˜å¹¶å‘æ€§èƒ½

### 3. ä»£ç è§„èŒƒ
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼
- âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- âœ… ç»Ÿä¸€æ—¥å¿—è®°å½•
- âœ… ä¸­æ–‡æ³¨é‡Šå®Œå–„

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
å»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

```python
# æµ‹è¯•PromptBuilder
- build_prompt() æ­£å¸¸æƒ…å†µ
- build_prompt() æŠ€èƒ½ä¸å­˜åœ¨
- build_prompt() æŠ€èƒ½å·²ç¦ç”¨
- intelligent_routing() æ­£å¸¸è·¯ç”±
- intelligent_routing() æ— åŒ¹é…æŠ€èƒ½

# æµ‹è¯•AgentServiceV2
- create_with_skills() æ™®é€šæ¨¡å¼
- create_with_skills() æŠ€èƒ½æ¨¡å¼
- update_with_skills() æ¨¡å¼åˆ‡æ¢
- get_detail_with_skills() åŒ…å«æŠ€èƒ½è¯¦æƒ…

# æµ‹è¯•è·¯ç”±
- æ‰€æœ‰æ¥å£çš„å“åº”æ ¼å¼
- å¼‚å¸¸å¤„ç†
- è¾“å…¥éªŒè¯
```

### 2. é›†æˆæµ‹è¯•
- åˆ›å»ºæŠ€èƒ½ â†’ åˆ›å»ºAgentï¼ˆæŠ€èƒ½æ¨¡å¼ï¼‰â†’ æ‰§è¡ŒAgent
- æµ‹è¯•æ™ºèƒ½è·¯ç”±åŠŸèƒ½
- æµ‹è¯•IPåŸºå› æ³¨å…¥

### 3. æ‰‹åŠ¨æµ‹è¯•æ¸…å•

#### æŠ€èƒ½åº“ç®¡ç†
- [ ] åˆ›å»ºæŠ€èƒ½ï¼ˆå„ç§åˆ†ç±»ï¼‰
- [ ] æ›´æ–°æŠ€èƒ½
- [ ] åˆ é™¤æŠ€èƒ½ï¼ˆè½¯åˆ é™¤ï¼‰
- [ ] è·å–æŠ€èƒ½åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
- [ ] è·å–åˆ†ç±»åˆ—è¡¨

#### Agentç®¡ç†
- [ ] åˆ›å»ºAgentï¼ˆæ™®é€šæ¨¡å¼ï¼‰
- [ ] åˆ›å»ºAgentï¼ˆæŠ€èƒ½æ¨¡å¼ï¼‰
- [ ] æ›´æ–°Agentï¼ˆåˆ‡æ¢æ¨¡å¼ï¼‰
- [ ] é¢„è§ˆPrompt
- [ ] åˆ é™¤Agent

#### Agentæ‰§è¡Œ
- [ ] æ‰§è¡ŒAgentï¼ˆæ™®é€šæ¨¡å¼ï¼‰
- [ ] æ‰§è¡ŒAgentï¼ˆæŠ€èƒ½æ¨¡å¼ï¼‰
- [ ] æ‰§è¡ŒAgentï¼ˆå¯ç”¨æ™ºèƒ½è·¯ç”±ï¼‰
- [ ] æ‰§è¡ŒAgentï¼ˆå¯ç”¨IPåŸºå› ï¼‰
- [ ] æ„å»ºPromptï¼ˆè°ƒè¯•æ¥å£ï¼‰

---

## âš ï¸ éƒ¨ç½²å‰æ£€æŸ¥

### 1. æ•°æ®åº“è¿ç§»
**å¿…é¡»æ‰§è¡Œä»¥ä¸‹SQLè¯­å¥**ï¼š

```sql
ALTER TABLE agents
ADD COLUMN agent_mode TINYINT DEFAULT 0 COMMENT '0-æ™®é€šæ¨¡å¼, 1-Skillç»„è£…æ¨¡å¼',
ADD COLUMN persona_id BIGINT DEFAULT NULL COMMENT 'å…³è”IPåŸºå› åº“ID',
ADD COLUMN skill_ids JSON COMMENT 'å­˜å‚¨æŠ€èƒ½IDæ•°ç»„ [1, 5, 20]',
ADD COLUMN skill_variables JSON COMMENT 'æŠ€èƒ½å˜é‡é…ç½® {skill_id: {var: value}}',
ADD COLUMN routing_description TEXT COMMENT 'è·¯ç”±ç‰¹å¾æè¿°',
ADD COLUMN is_routing_enabled TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯ç”¨æ™ºèƒ½è·¯ç”±ï¼š0-å¦ 1-æ˜¯';
```

### 2. ä¾èµ–æ£€æŸ¥
ç¡®ä¿å·²å®‰è£…ï¼š
```bash
pip install jinja2
```

### 3. ä»£ç æ£€æŸ¥
- [x] æ‰€æœ‰linteré”™è¯¯å·²ä¿®å¤
- [x] æ‰€æœ‰å¼‚æ­¥æ–¹æ³•æ­£ç¡®ä½¿ç”¨ `await`
- [x] æ‰€æœ‰å“åº”æ ¼å¼ç»Ÿä¸€
- [x] æ‰€æœ‰å¼‚å¸¸å¤„ç†ç»Ÿä¸€

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| ç±»åˆ« | ä¿®å¤æ•°é‡ | æ–‡ä»¶æ•° |
|------|---------|--------|
| ä¸¥é‡é—®é¢˜ | 7 | 5 |
| ä¸­ç­‰é—®é¢˜ | 3 | 3 |
| **æ€»è®¡** | **10** | **8** |

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **Tokenè®¡ç®—ä¼˜åŒ–**: ä½¿ç”¨ `tiktoken` åº“è¿›è¡Œå‡†ç¡®çš„tokenè®¡ç®—
2. **æ™ºèƒ½è·¯ç”±å‡çº§**: ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æ›¿ä»£å…³é”®è¯åŒ¹é…
3. **ç¼“å­˜ä¼˜åŒ–**: å¼•å…¥Redisç¼“å­˜ç»„è£…åçš„Prompt
4. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡å¯¼å…¥æŠ€èƒ½ã€æ‰¹é‡è¿ç§»Agent
5. **æ‰§è¡Œæ—¥å¿—**: è®°å½•Agentæ‰§è¡Œæ—¥å¿—ï¼Œç”¨äºä¼˜åŒ–è·¯ç”±

---

## âœ… ä¿®å¤å®Œæˆç¡®è®¤

- [x] Agentæ¨¡å‹å­—æ®µå·²æ·»åŠ 
- [x] æ‰€æœ‰æœåŠ¡æ–¹æ³•å·²å¼‚æ­¥åŒ–
- [x] æ‰€æœ‰è·¯ç”±å“åº”æ ¼å¼å·²ç»Ÿä¸€
- [x] Jinja2å®‰å…¨å·²ä¿®å¤
- [x] å¼‚å¸¸å¤„ç†å·²ç»Ÿä¸€
- [x] è¾“å…¥éªŒè¯å·²å¢å¼º
- [x] æ—¥å¿—è®°å½•å·²å®Œå–„
- [x] ä»£ç å·²é€šè¿‡linteræ£€æŸ¥

**ä¿®å¤çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œä»£ç å·²ç¬¦åˆé¡¹ç›®è§„èŒƒ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-19  
**ä¸‹æ¬¡å®¡æŸ¥å»ºè®®**: éƒ¨ç½²åè¿›è¡ŒåŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•

