# 算力充值系统配置说明

## 一、数据库配置

### 1.1 执行数据库迁移

执行以下SQL脚本创建表和插入初始数据：

```bash
mysql -u your_user -p your_database < backend/scripts/migration_add_recharge_system.sql
```

或者直接在MySQL客户端执行：

```sql
source backend/scripts/migration_add_recharge_system.sql
```

### 1.2 验证表结构

执行以下SQL验证表是否创建成功：

```sql
-- 检查套餐表
SHOW CREATE TABLE recharge_packages;

-- 检查compute_logs表扩展字段
DESC compute_logs;
```

## 二、环境变量配置

在 `.env` 文件中添加以下配置：

### 2.1 微信支付配置（必需）

```env
# 微信支付商户号（从微信支付商户平台获取）
WECHAT_PAY_MCH_ID=your_mch_id

# 微信支付API密钥（v2 API密钥，32位字符串）
# 在微信支付商户平台 -> API安全 -> API密钥中设置
WECHAT_PAY_API_KEY=your_api_key_32_chars

# 微信支付回调地址（必须是公网可访问的HTTPS地址）
# 格式：https://your-domain.com/api/v1/client/coin/recharge/callback
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/v1/client/coin/recharge/callback

# 微信支付IP白名单（可选，建议配置）
# 微信支付服务器IP段，多个用逗号分隔
# 默认值：182.254.48.0/24,140.207.54.0/24,101.226.103.0/24
# 注意：根据实际回调日志，微信支付可能使用多个IP段，需要包含 101.226.103.0/24
WECHAT_PAY_IP_WHITELIST=182.254.48.0/24,140.207.54.0/24,101.226.103.0/24
```

### 2.2 微信小程序配置（已存在，检查即可）

```env
# 微信小程序AppID
WECHAT_APP_ID=wxd9e4d8682e6caff6

# 微信小程序AppSecret
WECHAT_APP_SECRET=your_app_secret
```

## 三、微信支付配置步骤

### 3.1 获取商户号

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 在"账户中心" -> "商户信息"中查看商户号（MCH_ID）

### 3.2 设置API密钥

1. 进入"账户中心" -> "API安全" -> "API密钥"
2. 设置32位API密钥（建议使用随机生成）
3. 将密钥配置到 `WECHAT_PAY_API_KEY` 环境变量

### 3.3 配置支付回调

1. 进入"产品中心" -> "开发配置" -> "支付配置"
2. 设置"支付回调URL"为：`https://your-domain.com/api/v1/client/coin/recharge/callback`
3. 确保回调URL是HTTPS且公网可访问

### 3.4 配置IP白名单（可选但推荐）

1. 进入"账户中心" -> "API安全" -> "IP白名单"
2. 添加服务器IP地址
3. 或者在代码中配置 `WECHAT_PAY_IP_WHITELIST` 环境变量

## 四、Redis配置（可选）

如果已配置Redis，订单号生成会使用Redis原子递增，确保唯一性。

如果未配置Redis，系统会fallback到时间戳+随机数方式（存在极小概率重复）。

Redis配置（如果使用）：

```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_password
REDIS_DB=0
```

## 五、验证配置

### 5.1 检查配置是否生效

启动后端服务后，检查日志中是否有以下警告：

```
微信支付配置不完整，支付功能可能不可用
```

如果有此警告，说明配置未正确加载。

### 5.2 测试接口

1. **获取套餐列表**
   ```bash
   curl -X GET http://localhost:8000/api/v1/client/coin/packages
   ```

2. **创建订单**（需要登录token）
   ```bash
   curl -X POST http://localhost:8000/api/v1/client/coin/recharge/order \
     -H "Authorization: Bearer your_token" \
     -H "Content-Type: application/json" \
     -d '{"package_id": 1}'
   ```

## 六、生产环境注意事项

### 6.1 安全配置

1. **API密钥安全**
   - 不要将API密钥提交到代码仓库
   - 使用环境变量或密钥管理服务
   - 定期更换API密钥

2. **HTTPS要求**
   - 支付回调URL必须是HTTPS
   - 确保SSL证书有效

3. **IP白名单**
   - 建议配置IP白名单增强安全性
   - 定期检查微信支付IP段是否有更新

### 6.2 监控和告警

1. **支付回调监控**
   - 监控回调接口的调用频率
   - 设置异常告警（签名验证失败、IP不在白名单等）

2. **订单状态监控**
   - 监控pending状态的订单数量
   - 设置超时订单清理任务

### 6.3 数据备份

- 定期备份 `recharge_packages` 表
- 定期备份 `compute_logs` 表中的充值记录

## 七、常见问题

### Q1: 支付回调返回404

**原因**：回调URL配置错误或路由未注册

**解决**：
1. 检查 `WECHAT_PAY_NOTIFY_URL` 配置是否正确
2. 确认路由已正确注册到FastAPI应用

### Q2: 签名验证失败

**原因**：
1. API密钥配置错误
2. 签名算法不匹配（v2 API使用MD5）

**解决**：
1. 检查 `WECHAT_PAY_API_KEY` 是否正确
2. 确认使用的是v2 API密钥（不是v3的证书）

### Q3: IP白名单验证失败

**原因**：服务器IP不在白名单内

**解决**：
1. 检查服务器公网IP
2. 在微信支付商户平台添加IP白名单
3. 或临时禁用IP白名单验证（不推荐）

### Q4: 订单号重复

**原因**：Redis未配置或Redis不可用

**解决**：
1. 配置Redis连接
2. 或使用UUID生成订单号（需要修改代码）

## 八、配置检查清单

- [ ] 数据库迁移脚本已执行
- [ ] `WECHAT_PAY_MCH_ID` 已配置
- [ ] `WECHAT_PAY_API_KEY` 已配置（32位字符串）
- [ ] `WECHAT_PAY_NOTIFY_URL` 已配置（HTTPS地址）
- [ ] `WECHAT_PAY_IP_WHITELIST` 已配置（可选）
- [ ] 微信支付商户平台回调URL已配置
- [ ] 微信支付商户平台IP白名单已配置（可选）
- [ ] Redis已配置（可选，用于订单号唯一性）
- [ ] 后端服务已重启并加载新配置
- [ ] 测试接口调用正常

## 九、技术支持

如遇到配置问题，请检查：
1. 后端日志输出
2. 微信支付商户平台配置
3. 网络连接和防火墙设置
4. SSL证书有效性

