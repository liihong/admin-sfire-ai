# 后端架构设计文档

## 一、架构概述

本项目采用**分层架构 + 领域分组**的设计模式，实现业务逻辑与技术实现的分离，提升代码可维护性和可扩展性。

## 二、目录结构

```
backend/
├── models/                    # 数据模型层（统一管理，按领域分组）
│   ├── __init__.py           # 导出所有模型
│   ├── base.py               # BaseModel
│   ├── user.py               # User, AdminUser
│   ├── agent.py              # Agent, SkillLibrary
│   ├── conversation.py       # Conversation, ConversationMessage, ConversationChunk
│   ├── project.py            # Project
│   ├── coin.py               # Compute, ComputeFreeze
│   ├── content.py            # Banner, HomeConfig
│   └── system.py             # LLMModel, Dictionary, Menu, Role
│
├── schemas/                   # Schema层（统一管理，按领域分组）
│   ├── __init__.py           # 导出所有Schema
│   ├── common.py             # PageParams, Response等共享Schema
│   ├── user.py               # User相关Schema
│   ├── agent.py              # Agent相关Schema（v1和v2统一管理）
│   ├── conversation.py       # Conversation相关Schema
│   ├── project.py            # Project相关Schema
│   ├── coin.py               # Coin相关Schema
│   ├── content.py            # Content相关Schema
│   └── system.py             # System相关Schema
│
├── services/                  # 服务层（按领域分组，复杂领域使用子目录）
│   ├── __init__.py           # 导出主要服务类
│   │
│   ├── agent/                # Agent领域服务（复杂领域）
│   │   ├── __init__.py       # 导出Agent相关服务
│   │   ├── core.py           # Agent核心执行（纯技术：路由、Prompt、LLM）
│   │   ├── business.py       # Agent业务服务（权限、余额、编排）
│   │   └── admin.py          # Agent管理服务（CRUD）
│   │
│   ├── conversation/         # Conversation领域服务（复杂领域）
│   │   ├── __init__.py
│   │   ├── dao.py            # 数据访问层（CRUD，无业务逻辑）
│   │   ├── business.py       # 业务服务（权限、会话管理）
│   │   └── enhanced.py       # 增强服务（算力扣除、内容审查）
│   │
│   ├── coin/                # Coin领域服务（中等复杂度）
│   │   ├── __init__.py
│   │   ├── account.py        # 账户管理
│   │   ├── calculator.py     # 算力计算
│   │   └── freeze.py         # 冻结/结算
│   │
│   ├── user_service.py       # User领域服务（简单领域，单文件）
│   ├── project_service.py    # Project领域服务（简单领域）
│   ├── content_service.py    # Content领域服务（简单领域）
│   │
│   └── shared/              # 共享服务（跨领域）
│       ├── __init__.py
│       ├── llm_service.py    # LLM服务
│       ├── llm_factory.py    # LLM工厂
│       ├── embedding.py      # 向量化服务
│       ├── vector_db.py      # 向量数据库
│       └── prompt_builder.py # Prompt构建器
│
├── routers/                  # 路由层（按admin/client分类，内部按领域分组）
│   ├── __init__.py           # 聚合所有路由
│   │
│   ├── admin/                # 管理端路由
│   │   ├── __init__.py       # 聚合admin路由
│   │   ├── auth.py           # 认证
│   │   ├── agent.py          # Agent管理（包含v1和v2）
│   │   ├── user.py           # 用户管理
│   │   ├── conversation.py   # 对话管理
│   │   ├── coin.py           # 算力管理
│   │   ├── content.py        # 内容管理
│   │   └── system.py         # 系统管理
│   │
│   └── client/               # 客户端路由
│       ├── __init__.py       # 聚合client路由
│       ├── auth.py           # 认证
│       ├── agent.py          # Agent执行（包含v1和v2）
│       ├── conversation.py   # 对话管理
│       ├── project.py        # 项目管理
│       ├── coin.py           # 算力管理
│       └── content.py        # 内容相关
│
├── infrastructure/           # 基础设施层
│   ├── db/                   # 数据库连接、会话管理
│   ├── middleware/           # 中间件（限流、余额检查）
│   ├── core/                 # 核心配置（config, security, deps）
│   └── constants/           # 常量定义
│
└── utils/                    # 工具函数
    ├── response.py
    ├── exceptions.py
    ├── pagination.py
    └── ...
```

## 三、架构原则

### 3.1 技术层次分离

- **Models层**：数据模型定义，与数据库表一一对应
- **Schemas层**：API请求/响应Schema，用于数据验证
- **Services层**：业务逻辑实现
- **Routers层**：API路由定义，处理HTTP请求

### 3.2 领域分组

在Services和Routers层按业务领域分组：

**简单领域（单文件）**：
- 服务文件数量 ≤ 2个
- 职责单一，无明显分离
- 示例：user_service.py, project_service.py

**复杂领域（子目录）**：
- 服务文件数量 ≥ 3个
- 有明显职责分离（core/business/admin/dao）
- 示例：agent/, conversation/, coin/

### 3.3 职责分离

**Services层职责划分**：

1. **Core服务**（纯技术实现）
   - 路由决策
   - Prompt组装
   - LLM调用
   - 不涉及业务逻辑（权限、余额等）

2. **Business服务**（业务逻辑）
   - 权限验证
   - 余额检查
   - 会话管理
   - 调用Core服务执行

3. **Admin服务**（管理功能）
   - CRUD操作
   - 配置管理
   - 数据统计

4. **DAO服务**（数据访问）
   - CRUD操作
   - 查询优化
   - 无业务逻辑

5. **Enhanced服务**（增强功能）
   - 算力扣除
   - 内容审查
   - 调用其他服务

## 四、领域划分

### 4.1 用户领域（User Domain）
- 用户管理
- 管理员用户
- 认证授权

### 4.2 Agent领域（Agent Domain）
- Agent配置管理
- Agent执行（核心）
- 技能库管理
- 路由决策

### 4.3 对话领域（Conversation Domain）
- 会话管理
- 消息管理
- 语义搜索
- 向量化

### 4.4 项目领域（Project Domain）
- 项目管理
- IP人设配置

### 4.5 算力领域（Coin Domain）
- 算力账户
- 算力计算
- 冻结/结算

### 4.6 内容领域（Content Domain）
- 内容审查
- Banner管理
- 首页配置

### 4.7 系统领域（System Domain）
- LLM模型管理
- 数据字典
- 菜单管理
- 角色权限

## 五、依赖关系

```
Routers层
  ↓ 调用
Services层
  ├─ Business服务（业务逻辑）
  │   ├─ 权限验证
  │   ├─ 余额检查
  │   └─ 调用Core服务
  │
  ├─ Core服务（纯技术）
  │   ├─ 路由决策
  │   ├─ Prompt组装
  │   └─ LLM调用
  │
  └─ DAO服务（数据访问）
      └─ CRUD操作
          ↓ 使用
Models层
```

## 六、版本管理

### 6.1 Schema版本管理

- **不使用目录区分版本**（如schemas/v2/）
- **使用命名空间区分版本**：
  ```python
  # schemas/agent.py
  class AgentCreate(BaseModel):  # v1版本
      ...
  
  class v2:  # v2版本命名空间
      class AgentExecuteRequest(BaseModel):
          ...
  ```

### 6.2 路由版本管理

- **在main.py中统一管理版本前缀**：
  ```python
  app.include_router(admin_router, prefix="/api/v1/admin")
  app.include_router(client_v2_router, prefix="/api/v2/client")
  ```

- **路由文件内部通过路由分组区分版本**：
  ```python
  # routers/admin/agent.py
  router_v1 = APIRouter(prefix="/agents", tags=["Agent管理"])
  router_v2 = APIRouter(prefix="/agents", tags=["Agent管理（v2）"])
  ```

## 七、API路径规范

### 7.1 API路径结构

所有API路径遵循以下规范：

```
/api/{version}/{client_type}/{domain}/{resource}/{action}
```

- `version`: v1, v2
- `client_type`: admin, client
- `domain`: agent, conversation, user等
- `resource`: agents, conversations等
- `action`: list, create, update等

### 7.2 路径示例

**管理端（Admin）**：
- `/api/v1/admin/agents` - Agent列表
- `/api/v1/admin/agents/{id}` - Agent详情
- `/api/v2/admin/agents/list` - Agent列表（v2）

**客户端（Client）**：
- `/api/v1/client/agents` - Agent列表
- `/api/v2/client/execution/agents/{id}/execute` - Agent执行（v2）

### 7.3 路径兼容性

**重要**：重构后API路径完全不变，前端无需修改。

- 路径前缀在main.py中统一管理
- 路由文件内部路径保持不变
- 仅内部代码组织方式改变

## 八、导入规范

### 8.1 导入顺序

```python
# 1. 标准库
from typing import Optional, List
from datetime import datetime

# 2. 第三方库
from sqlalchemy import select
from loguru import logger

# 3. 本地库（按层次）
from models.agent import Agent
from schemas.agent import AgentCreate
from services.agent.business import AgentBusinessService
from utils.exceptions import NotFoundException
```

### 8.2 导入路径

- 使用绝对导入
- 避免相对导入（from .. import）
- 导入路径清晰，体现层次关系

## 九、注释规范

### 9.1 模块级注释

```python
"""
模块名称
模块功能描述
关键设计决策说明
"""
```

### 9.2 类级注释

```python
class AgentBusinessService:
    """
    类功能描述
    
    职责说明：
    - 权限验证
    - 余额检查
    - 调用Agent核心执行
    
    使用示例：
        service = AgentBusinessService(db)
        async for chunk in service.execute_agent(...):
            ...
    """
```

### 9.3 方法级注释

```python
async def execute_agent(
    self,
    agent_id: int,
    user_id: int,
    input_text: str
) -> AsyncGenerator[str, None]:
    """
    执行Agent（完整业务流程）
    
    业务逻辑：
    1. 验证用户权限
    2. 验证Agent状态
    3. 检查余额
    4. 调用Agent核心执行
    5. 保存对话记录
    
    Args:
        agent_id: Agent ID
        user_id: 用户ID
        input_text: 用户输入
    
    Yields:
        流式输出的文本块
    
    Raises:
        NotFoundException: Agent不存在
        BadRequestException: 余额不足或权限不足
    """
```

## 十、扩展指南

### 10.1 新增领域

1. 在models/中添加模型文件
2. 在schemas/中添加Schema文件
3. 在services/中添加服务文件或目录
4. 在routers/中添加路由文件
5. 更新__init__.py导出

### 10.2 新增版本

1. 在Schema中使用命名空间区分
2. 在路由中使用路由分组区分
3. 在main.py中注册新版本路由

## 十一、最佳实践

1. **保持职责单一**：每个类只负责一个职责
2. **业务逻辑与技术实现分离**：Core服务不包含业务逻辑
3. **数据访问与业务逻辑分离**：DAO服务不包含业务逻辑
4. **版本管理统一**：不使用目录区分版本
5. **注释完整**：每个类和方法都有文档字符串
6. **导入路径清晰**：体现层次关系

