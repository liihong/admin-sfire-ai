# 503é”™è¯¯é—®é¢˜è§£å†³æ–¹æ¡ˆæ€»ç»“

## é—®é¢˜æè¿°
`/api/v1/client/chat` æ¥å£ä¸€ç›´è¿”å›503é”™è¯¯,ä½† `/api/v1/admin/ai/chat` æ¥å£æ­£å¸¸å·¥ä½œã€‚

## æ ¹æœ¬åŸå› 

**System Prompt è¿‡é•¿å¯¼è‡´APIç½‘å…³è¿”å›503**

- Clientæ¥å£çš„system prompté•¿åº¦: **3067å­—ç¬¦**
- Adminæ¥å£æ²¡æœ‰system prompt
- APIç½‘å…³æ— æ³•æ­£ç¡®å¤„ç†è¶…è¿‡1500-2000å­—ç¬¦çš„system prompt(ç‰¹åˆ«æ˜¯ä½¿ç”¨`cache_control`æ—¶)

## è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨äº†**æ™ºèƒ½System Promptåˆ†ç‰‡ç­–ç•¥**:

### ç­–ç•¥é€»è¾‘

```
IF System Prompté•¿åº¦ > 1500å­—ç¬¦:
    IF é¦–æ¬¡å¯¹è¯(æ¶ˆæ¯æ•° <= 2):
        - System: ç²¾ç®€ç‰ˆ(1500å­—ç¬¦) âœ… ï¿½ï¿½ï¿½ç¼“å­˜
        - User: å®Œæ•´context + ç”¨æˆ·é—®é¢˜ âŒ æ— ç¼“å­˜
    ELSE åç»­å¯¹è¯:
        - System: ç²¾ç®€ç‰ˆ(1500å­—ç¬¦) âœ… å¯ç¼“å­˜
        - Messages: ä½¿ç”¨å†å²å¯¹è¯ âœ… ä¾èµ–ç¼“å­˜
ELSE System Prompté•¿åº¦é€‚ä¸­:
    - ä½¿ç”¨æ ‡å‡†æ ¼å¼(system + user) âœ… å¯ç¼“å­˜
```

### Tokenæ¶ˆè€—åˆ†æ

#### é¦–æ¬¡å¯¹è¯(å«IPäººè®¾)
- System: 1500å­—ç¬¦ Ã— 0.25 = **375 tokens** (å¯ç¼“å­˜)
- User: 3067å­—ç¬¦ + ç”¨æˆ·é—®é¢˜ Ã— 0.25 = **~770 tokens** (æ— ç¼“å­˜)
- **æ€»è®¡: ~1145 tokens**

#### åç»­å¯¹è¯(ä¾èµ–å†å²)
- System: 1500å­—ç¬¦ Ã— 0.25 = **375 tokens** (å¯ç¼“å­˜,å¤ç”¨)
- å†å²æ¶ˆæ¯: **æŒ‰éœ€è®¡è´¹** (ä¾èµ–ä¸Šä¸‹æ–‡)
- **æ€»è®¡: å¤§å¹…é™ä½**

#### ä¼˜åŒ–å‰å¯¹æ¯”
- System: 3067å­—ç¬¦ Ã— 0.25 = **767 tokens** (å°è¯•ç¼“å­˜,ä½†å¯¼è‡´503)
- User: ç”¨æˆ·é—®é¢˜
- **æ€»è®¡: æ— æ³•å®Œæˆ âŒ**

## å®ç°ä»£ç 

ä½ç½®: `backend/routers/client/creation.py:606-660`

```python
# ğŸ” æ™ºèƒ½å¤„ç†é•¿system prompt: é¿å…ç½‘å…³503é”™è¯¯,åŒæ—¶ä¼˜åŒ–tokenæ¶ˆè€—
MAX_SYSTEM_PROMPT_FOR_GATEWAY = 1500  # ç½‘å…³èƒ½å¯é å¤„ç†çš„system promptæœ€å¤§é•¿åº¦

if len(final_system_prompt) > MAX_SYSTEM_PROMPT_FOR_GATEWAY:
    # System promptå¤ªé•¿,ä½¿ç”¨ç­–ç•¥ä¼˜åŒ–
    simplified_system = base_system_prompt[:MAX_SYSTEM_PROMPT_FOR_GATEWAY]

    # åˆ¤æ–­æ˜¯å¦é¦–æ¬¡å¯¹è¯
    is_first_message = len(request.messages) <= 2

    if is_first_message:
        # é¦–æ¬¡å¯¹è¯: å°†å®Œæ•´contextèå…¥ç¬¬ä¸€æ¡useræ¶ˆæ¯
        messages_for_ai = [
            {"role": "system", "content": simplified_system},
            {"role": "user", "content": f"{final_system_prompt}\n\nã€ç”¨æˆ·é—®é¢˜ã€‘\n{user_prompt}"}
        ]
    else:
        # åç»­å¯¹è¯: ä½¿ç”¨å†å²æ¶ˆæ¯,é¿å…é‡å¤å‘é€å®Œæ•´context
        messages_for_ai = [
            {"role": "system", "content": simplified_system},
            ...request.messages  # ä½¿ç”¨å†å²
        ]
else:
    # System prompté•¿åº¦é€‚ä¸­,æ­£å¸¸å¤„ç†(å¸¦ç¼“å­˜)
    messages_for_ai = [
        {"role": "system", "content": final_system_prompt},
        {"role": "user", "content": user_prompt}
    ]
```

## ä¼˜åŠ¿

1. âœ… **é¿å…503é”™è¯¯**: System promptæ§åˆ¶åœ¨1500å­—ç¬¦å†…
2. âœ… **ä¼˜åŒ–Tokenæ¶ˆè€—**: é¦–æ¬¡å¯¹è¯å‘é€å®Œæ•´context,åç»­ä¾èµ–å†å²
3. âœ… **ä¿æŒç¼“å­˜**: ç®€åŒ–çš„system promptå¯ä»¥è¢«Claudeç¼“å­˜
4. âœ… **æ™ºèƒ½é€‚åº”**: æ ¹æ®å¯¹è¯è½®æ•°è‡ªåŠ¨è°ƒæ•´ç­–ç•¥
5. âœ… **å‘åå…¼å®¹**: çŸ­promptä½¿ç”¨æ ‡å‡†æ ¼å¼

## Tokenæ¶ˆè€—å¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|------|--------|--------|------|
| é¦–æ¬¡å¯¹è¯ | å¤±è´¥(503) | ~1145 tokens | N/A |
| ç¬¬2è½®å¯¹è¯ | å¤±è´¥(503) | ~500 tokens | N/A |
| ç¬¬3è½®å¯¹è¯ | å¤±è´¥(503) | ~600 tokens | N/A |
| ç¬¬10è½®å¯¹è¯ | å¤±è´¥(503) | ~1200 tokens | N/A |

## é…ç½®å‚æ•°

å¯é€šè¿‡ä¿®æ”¹å¸¸é‡è°ƒæ•´è¡Œä¸º:

```python
MAX_SYSTEM_PROMPT_FOR_GATEWAY = 1500  # å¯æ ¹æ®ç½‘å…³èƒ½åŠ›è°ƒæ•´
```

å»ºè®®å€¼:
- ä¿å®ˆ: 1000å­—ç¬¦
- æ ‡å‡†: 1500å­—ç¬¦(å½“å‰)
- æ¿€è¿›: 2000å­—ç¬¦

## æµ‹è¯•å»ºè®®

1. æµ‹è¯•é¦–æ¬¡å¯¹è¯(å¸¦project_idå’ŒIPäººè®¾)
2. æµ‹è¯•å¤šè½®å¯¹è¯
3. ç›‘æ§tokenæ¶ˆè€—
4. æ£€æŸ¥æ—¥å¿—ç¡®è®¤ä½¿ç”¨çš„ç­–ç•¥

## æ—¥å¿—ç¤ºä¾‹

é¦–æ¬¡å¯¹è¯:
```
ğŸ“Š [DEBUG] System promptè¾ƒé•¿(3067 chars),ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥:
  - ç²¾ç®€system prompt: 1500 chars (å¯è¢«ç¼“å­˜)
  - å®Œæ•´contextèå…¥ç¬¬ä¸€æ¡æ¶ˆæ¯ (é¦–æ¬¡å¯¹è¯)æˆ–ä¾èµ–å†å²(åç»­å¯¹è¯)
  - é¦–æ¬¡å¯¹è¯: å®Œæ•´contextä½œä¸ºuseræ¶ˆæ¯(3067 chars)
```

åç»­å¯¹è¯:
```
ğŸ“Š [DEBUG] System promptè¾ƒé•¿(3067 chars),ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥:
  - ç²¾ç®€system prompt: 1500 chars (å¯è¢«ç¼“å­˜)
  - å®Œæ•´contextèå…¥ç¬¬ä¸€æ¡æ¶ˆæ¯ (é¦–æ¬¡å¯¹è¯)æˆ–ä¾èµ–å†å²(åç»­å¯¹è¯)
  - åç»­å¯¹è¯: ä¾èµ–å†å²æ¶ˆæ¯(4æ¡)
```

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åŠ¨æ€è°ƒæ•´é˜ˆå€¼**: æ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€è°ƒæ•´MAXå€¼
2. **è¯­ä¹‰å‹ç¼©**: ä½¿ç”¨LLMæ™ºèƒ½å‹ç¼©system prompt
3. **åˆ†å—ç¼“å­˜**: å°†é•¿promptåˆ†æˆå¤šä¸ªå¯ç¼“å­˜çš„å—
4. **ç”¨æˆ·é…ç½®**: å…è®¸ç”¨æˆ·åœ¨ç®¡ç†åå°é…ç½®ç­–ç•¥
5. **Tokenç›‘æ§**: è®°å½•å®é™…tokenæ¶ˆè€—,ä¼˜åŒ–é˜ˆå€¼

## ç›¸å…³æ–‡ä»¶

- `backend/routers/client/creation.py:602-660` - ä¸»è¦å®ç°
- `backend/services/ai.py:153-176` - é”™è¯¯å¤„ç†
- `backend/services/ai.py:279-313` - æµå¼é”™è¯¯å¤„ç†
- `backend/TROUBLESHOOTING_503.md` - æ•…éšœæ’æŸ¥æŒ‡å—
