# 智能体调试中心（Playground）配置指南

## 📋 配置步骤

### 1. 添加 Playground 菜单到数据库

运行脚本添加菜单：

```bash
cd backend
python scripts/add_playground_menu.py
```

**脚本说明**：
- 会在智能体管理菜单下添加一个隐藏的子菜单
- 菜单路径：`/agent/playground/:id`
- 组件路径：`/agent/playground/index`
- 设置为隐藏菜单（`is_hide: True`），因为这是通过ID动态访问的页面

### 2. 配置 OpenAI API Key

在 `.env` 文件中配置 OpenAI API Key：

```env
OPENAI_API_KEY=sk-your-openai-api-key-here
```

**注意**：如果没有配置 API Key，AI 对话功能将无法使用。

### 3. 验证后端接口

#### 3.1 检查接口是否注册

确认 `backend/app/api/v1/router.py` 中已包含 AI 路由：

```python
from .endpoints import auth, users, dashboard, menu, agents, roles, admin_users, ai

# AI 对话路由
api_router.include_router(
    ai.router,
    prefix="/ai",
    tags=["AI 对话"]
)
```

#### 3.2 测试接口

启动后端服务后，访问 Swagger UI：http://localhost:8000/docs

确认以下接口存在：
- ✅ `POST /v1/ai/chat/stream` - SSE 流式对话接口
- ✅ `POST /v1/ai/chat` - 非流式对话接口（可选）

### 4. 前端环境变量

确保 `frontend/.env` 或 `.env.development` 中配置了：

```env
VITE_API_URL=/api
```

## 🔍 功能测试清单

### 测试前准备

1. ✅ 后端服务已启动
2. ✅ 数据库已连接
3. ✅ 已运行菜单添加脚本
4. ✅ OpenAI API Key 已配置
5. ✅ 前端服务已启动
6. ✅ 已登录管理员账号

### 测试步骤

#### 测试 1: 菜单配置验证

1. 登录管理系统
2. 进入"系统管理" > "菜单管理"
3. 查找"智能体管理"菜单
4. 展开查看是否有"智能体调试中心"子菜单（隐藏状态）
5. ✅ **预期结果**：菜单存在且为隐藏状态

#### 测试 2: 路由跳转测试

1. 进入"智能体配置"页面（`/agent/index`）
2. 在智能体列表中找到一个智能体
3. 点击"调试"按钮
4. ✅ **预期结果**：页面跳转到 `/agent/playground/{agent_id}`

#### 测试 3: 页面加载测试

1. 进入 Playground 页面
2. 检查左侧配置面板是否正常显示
3. 检查右侧聊天面板是否正常显示
4. 检查智能体信息是否正确加载
5. ✅ **预期结果**：
   - 页面正常渲染
   - 智能体名称、图标等信息正确显示
   - System Prompt 正确加载

#### 测试 4: 配置面板功能测试

1. **Prompt 模板选择**：
   - 点击"Prompt 模板"下拉框
   - 选择一个预设模板（如"小红书风格"）
   - ✅ **预期结果**：System Prompt 自动填充模板内容

2. **System Prompt 编辑器**：
   - 编辑 System Prompt 内容
   - 检查行号是否正确显示
   - 测试复制、清空功能
   - ✅ **预期结果**：编辑器功能正常

3. **模型参数调整**：
   - 调整 Temperature 滑块（0-2）
   - 调整 Max Tokens 数值
   - 调整其他参数
   - ✅ **预期结果**：参数值实时更新

4. **上下文预设**：
   - 点击"添加示例"
   - 输入用户消息和助手回复
   - 测试删除示例
   - ✅ **预期结果**：示例数据可以正常添加和删除

#### 测试 5: 聊天功能测试

1. **发送消息**：
   - 在输入框中输入测试消息
   - 点击"开始调试"按钮或按 Ctrl/Cmd + Enter
   - ✅ **预期结果**：消息出现在聊天窗口中

2. **流式输出测试**：
   - 观察 AI 回复是否以流式方式显示
   - 检查是否有打字机动画效果
   - 检查光标闪烁动画
   - ✅ **预期结果**：
     - 内容逐字显示
     - 有流畅的打字机效果
     - 自动滚动到底部

3. **Markdown 渲染测试**：
   - 测试代码块渲染（```代码```）
   - 测试行内代码（`code`）
   - 测试粗体、斜体、链接等格式
   - ✅ **预期结果**：Markdown 格式正确渲染

4. **多轮对话测试**：
   - 连续发送多条消息
   - 检查对话历史是否正确保存
   - ✅ **预期结果**：所有消息按顺序显示

#### 测试 6: 保存配置测试

1. 修改 System Prompt 和模型参数
2. 点击右上角"保存配置"按钮
3. 确认保存操作
4. ✅ **预期结果**：
   - 弹出确认对话框
   - 保存成功后显示成功提示
   - 配置已保存到数据库

#### 测试 7: 左右分屏测试

1. **拖拽调整宽度**：
   - 鼠标悬停在分割线上
   - 按住鼠标左键拖动
   - ✅ **预期结果**：左侧面板宽度可以调整（300px-800px）

2. **折叠左侧面板**：
   - 点击左侧面板右上角的关闭按钮
   - ✅ **预期结果**：左侧面板折叠，右侧面板占据全宽

#### 测试 8: 错误处理测试

1. **网络错误**：
   - 断开网络后发送消息
   - ✅ **预期结果**：显示错误提示

2. **API 错误**：
   - 如果 OpenAI API Key 未配置或无效
   - ✅ **预期结果**：显示明确的错误提示

3. **权限错误**：
   - 使用无权限账号访问
   - ✅ **预期结果**：无法访问或显示权限错误

## 🐛 常见问题排查

### 问题 1: 点击"调试"按钮后页面 404

**可能原因**：
- 菜单未添加到数据库
- 路由未正确配置

**解决方法**：
1. 运行 `python scripts/add_playground_menu.py`
2. 检查前端路由配置
3. 刷新页面并重新登录

### 问题 2: SSE 流式输出不工作

**可能原因**：
- OpenAI API Key 未配置
- 网络连接问题
- 后端接口未正确实现

**解决方法**：
1. 检查 `.env` 文件中的 `OPENAI_API_KEY`
2. 检查浏览器控制台错误信息
3. 检查后端日志
4. 在 Swagger UI 中测试接口

### 问题 3: 保存配置失败

**可能原因**：
- 智能体数据不存在
- 缺少必填字段
- 数据库连接问题

**解决方法**：
1. 检查智能体是否存在
2. 查看后端错误日志
3. 检查数据库连接

### 问题 4: Markdown 渲染异常

**可能原因**：
- 使用了复杂的 Markdown 语法
- 当前实现只支持基础语法

**解决方法**：
- 当前使用简单的字符串替换实现
- 如需更强大的功能，可以安装 `markdown-it` 库

## 📝 注意事项

1. **OpenAI API 费用**：使用 OpenAI API 会产生费用，请注意使用量
2. **API 限流**：OpenAI API 有速率限制，频繁请求可能会被限流
3. **Token 消耗**：长文本和大量上下文会增加 Token 消耗
4. **安全性**：确保 OpenAI API Key 安全，不要提交到代码仓库

## ✨ 后续优化建议

1. 添加消息历史记录持久化
2. 添加代码高亮（使用 highlight.js）
3. 添加导出对话功能
4. 添加参数预设模板管理
5. 优化 Markdown 渲染（使用 markdown-it 库）
6. 添加消息搜索功能
7. 添加 Token 使用统计
8. 添加错误重试机制

