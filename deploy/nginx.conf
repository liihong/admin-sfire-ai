# SFire Admin Nginx 配置文件
# 后台管理系统部署在 /sfire-admin 路径下，根路径留给未来官网使用
# 
# 使用方法：
# 1. 将此文件复制到 /etc/nginx/sites-available/sfire-admin
# 2. 创建符号链接: sudo ln -s /etc/nginx/sites-available/sfire-admin /etc/nginx/sites-enabled/
# 3. 确保前端 .env.production 中设置 VITE_PUBLIC_PATH=/sfire-admin
# 4. 测试配置: sudo nginx -t
# 5. 重新加载: sudo systemctl reload nginx

# HTTP 服务器配置（重定向到 HTTPS）
http{
    # 站点：sourcefire.cn
# 逻辑：80 重定向到 443，443 处理业务

# --- 1. HTTP 重定向 ---
server {
    listen 80;
    server_name sourcefire.cn www.sourcefire.cn;

    # Let's Encrypt 验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# --- 2. HTTPS 业务配置 ---
server {
    listen 443 ssl http2;
    server_name sourcefire.cn www.sourcefire.cn;

    # 证书路径优化 (使用 live 路径)
    ssl_certificate /etc/letsencrypt/live/sourcefire.cn.pem;;
    ssl_certificate_key /etc/letsencrypt/live/sourcefire.cn.pem;;

    # SSL 性能优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 安全响应头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # 日志
    access_log /var/log/nginx/sfire-admin-access.log;
    error_log /var/log/nginx/sfire-admin-error.log;

    # 根目录 (未来官网)
    root /var/www/html;
    index index.html;

    # 后台管理系统路径修复
    location /sfire-admin/ {
        alias /var/www/html/sfire-admin/;
        index index.html;
        try_files $uri $uri/ /sfire-admin/index.html;

        # 解决嵌套正则导致的 alias 丢失与 MIME 报错
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            alias /var/www/html/sfire-admin/; # 必须重复声明
            expires 1y;
            add_header Cache-Control "public, immutable";
            
            # 强制 JS 文件的 MIME 类型，防止被识别为 text/plain
            types {
                application/javascript js;
                text/css css;
            }
        }
    }

    # 后端 API 代理 (针对 AI 业务优化)
    location /api/ {
        # 验证暗号
        if ($http_x_my_gate_key != "Huoyuan2026") {
            return 403;
        }

        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 解决 AI 流式输出卡顿
        proxy_buffering off;
        proxy_request_buffering off;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 增加超时，防止 AI 长时间思考导致 504
        proxy_read_timeout 600s;
    }

    # 隐藏文件保护
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

}

events {
    worker_connections 1024;
}