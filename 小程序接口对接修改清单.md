# 微信小程序接口对接修改清单

本文档说明在集成新的后端接口后，小程序端需要进行的修改。

## 一、接口基础信息

### 1. API 基础路径
**新路径前缀：** `/api/v1/client`

**完整URL格式：** `https://your-domain.com/api/v1/client/{路由}`

**重要变更：** 路径前缀从 `/api/v1/miniprogram` 变更为 `/api/v1/client`

### 2. 统一响应格式
所有接口统一返回以下格式：

```json
{
  "code": 200,        // 状态码：200=成功，400=参数错误，401=未授权，500=服务器错误
  "data": {},         // 响应数据
  "msg": "操作成功"    // 响应消息
}
```

**注意：** 
- 登录接口（`/auth/login`）直接返回 `LoginResponse` 模型，不使用统一响应格式包装
- 其他接口使用统一格式

---

## 二、接口路径变更清单

### 1. 认证相关接口

#### 1.1 微信登录
- **新路径：** `POST /api/v1/client/auth/login`
- **旧路径：** `POST /api/v1/miniprogram/auth/login` ❌
- **请求体：**
  ```json
  {
    "code": "微信登录code，从uni.login()获取"
  }
  ```
- **响应示例：**
  ```json
  {
    "success": true,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "openid": "xxx",
      "nickname": "微信用户",
      "avatarUrl": "",
      "gender": 0,
      "city": "",
      "province": "",
      "country": ""
    }
  }
  ```
  
  **注意：** 登录接口直接返回 `LoginResponse` 模型，不使用统一响应格式包装。其他接口使用统一格式。

#### 1.2 获取当前用户信息
- **新路径：** `GET /api/v1/client/auth/user`
- **旧路径：** `GET /api/v1/miniprogram/auth/user` ❌
- **需要认证：** 是（需携带 Authorization header）
- **响应示例：**
  ```json
  {
    "code": 200,
    "data": {
      "success": true,
      "userInfo": {
        "openid": "xxx",
        "nickname": "微信用户",
        "avatarUrl": "",
        "gender": 0,
        "city": "",
        "province": "",
        "country": ""
      }
    },
    "msg": "获取成功"
  }
  ```

---

### 2. 项目管理接口

#### 2.1 获取项目列表
- **新路径：** `GET /api/v1/client/projects`
- **旧路径：** `GET /api/v1/miniprogram/projects` ❌
- **需要认证：** 是
- **响应示例：**
  ```json
  {
    "success": true,
    "projects": [
      {
        "id": 1,
        "name": "项目名称",
        "industry": "医疗健康",
        "avatar_letter": "A",
        "avatar_color": "#3B82F6",
        "persona_settings": {},
        "is_active": false,
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
      }
    ],
    "active_project_id": "1"
  }
  ```

#### 2.2 创建项目
- **新路径：** `POST /api/v1/client/projects`
- **旧路径：** `POST /api/v1/miniprogram/projects` ❌
- **需要认证：** 是
- **请求体：**
  ```json
  {
    "name": "项目名称",
    "industry": "医疗健康",
    "avatar_letter": "A",
    "avatar_color": "#3B82F6",
    "persona_settings": {
      "tone": "专业亲和",
      "catchphrase": "",
      "target_audience": "",
      "benchmark_accounts": [],
      "content_style": "",
      "taboos": [],
      "keywords": [],
      "introduction": ""
    }
  }
  ```

#### 2.3 获取当前激活项目
- **新路径：** `GET /api/v1/client/projects/active`
- **旧路径：** `GET /api/v1/miniprogram/projects/active` ❌
- **需要认证：** 是

#### 2.4 切换激活项目
- **新路径：** `POST /api/v1/client/projects/switch`
- **旧路径：** `POST /api/v1/miniprogram/projects/switch` ❌
- **需要认证：** 是
- **请求体：**
  ```json
  {
    "project_id": "1"
  }
  ```
  **注意：** `project_id` 为字符串类型

#### 2.5 获取选项配置
- **新路径：** `GET /api/v1/client/projects/options`
- **旧路径：** `GET /api/v1/miniprogram/projects/options` ❌
- **需要认证：** 否（公开接口）
- **响应包含：**
  - `industries`: 行业选项列表
  - `tones`: 语气风格选项列表

#### 2.6 获取项目详情
- **新路径：** `GET /api/v1/client/projects/{project_id}`
- **旧路径：** `GET /api/v1/miniprogram/projects/{project_id}` ❌
- **需要认证：** 是

#### 2.7 更新项目
- **新路径：** `PUT /api/v1/client/projects/{project_id}`
- **旧路径：** `PUT /api/v1/miniprogram/projects/{project_id}` ❌
- **需要认证：** 是

#### 2.8 删除项目
- **新路径：** `DELETE /api/v1/client/projects/{project_id}`
- **旧路径：** `DELETE /api/v1/miniprogram/projects/{project_id}` ❌
- **需要认证：** 是

---

### 3. 内容生成接口

**重要变更：** 路径从 `/generate` 变更为 `/creation`

#### 3.1 获取智能体列表
- **新路径：** `GET /api/v1/client/creation/agents`
- **旧路径：** `GET /api/v1/miniprogram/generate/agents` ❌
- **需要认证：** 否（公开接口）
- **响应示例：**
  ```json
  {
    "success": true,
    "agents": [
      {
        "type": "efficient_oral",
        "name": "高效口播",
        "description": "...",
        "icon": "..."
      }
    ]
  }
  ```

#### 3.2 对话式内容生成
- **新路径：** `POST /api/v1/client/creation/chat`
- **旧路径：** `POST /api/v1/miniprogram/generate/chat` ❌
- **需要认证：** 是
- **请求体：**
  ```json
  {
    "project_id": 1,
    "agent_type": "efficient_oral",
    "messages": [
      {"role": "user", "content": "用户消息"},
      {"role": "assistant", "content": "助手回复"}
    ],
    "model_type": "deepseek",
    "temperature": 0.7,
    "max_tokens": 2048,
    "stream": true
  }
  ```
- **流式响应：** 当 `stream: true` 时，返回 SSE 格式流式数据
- **非流式响应：** 当 `stream: false` 时，返回完整内容

#### 3.3 快速生成
- **新路径：** `POST /api/v1/client/creation/chat/quick`
- **旧路径：** `POST /api/v1/miniprogram/generate/chat/quick` ❌
- **需要认证：** 是
- **请求参数（Query）：**
  - `content`: 创作内容/主题（必填）
  - `agent_type`: 智能体类型（默认：`efficient_oral`）
  - `project_id`: 项目ID（可选）
  - `model_type`: 模型类型（默认：`deepseek`）
- **注意：** 此接口使用 Query 参数，不是 Request Body

---

### 4. 抖音分析接口

#### 4.1 分析抖音账号
- **新路径：** `POST /api/v1/client/tikhub/analyze-douyin`
- **旧路径：** `POST /api/v1/miniprogram/tikhub/analyze-douyin` ❌
- **需要认证：** 是
- **请求体：**
  ```json
  {
    "url": "https://www.douyin.com/user/xxx"
  }
  ```
- **响应示例：**
  ```json
  {
    "success": true,
    "data": {
      "nickname": "抖音昵称",
      "signature": "抖音简介",
      "avatar_url": "头像URL",
      "industry_guess": "医疗健康",
      "keywords": ["关键词1", "关键词2"],
      "tone_guess": "专业亲和",
      "target_audience_guess": "25-55岁关注健康的用户",
      "follower_count": 100000,
      "video_count": 50
    },
    "message": "采集成功"
  }
  ```

---

## 三、认证方式变更

### 1. Token 存储
登录成功后，需要保存返回的 `token` 值：

```javascript
// 登录成功后
const response = await loginApi(code);
// 登录接口直接返回 LoginResponse，不使用统一格式包装
const token = response.data.token;  // 注意：登录接口的 token 在根级别
// 存储 token
uni.setStorageSync('token', token);
```

### 2. 请求头设置
**所有需要认证的接口**必须在请求头中携带：

```javascript
headers: {
  'Authorization': `Bearer ${token}`,  // 注意格式：Bearer + 空格 + token
  'Content-Type': 'application/json'
}
```

**示例（uni.request）：**
```javascript
uni.request({
  url: 'https://your-domain.com/api/v1/client/projects',
  method: 'GET',
  header: {
    'Authorization': `Bearer ${uni.getStorageSync('token')}`,
    'Content-Type': 'application/json'
  }
});
```

### 3. Token 过期处理
如果接口返回 `401` 状态码，说明 token 已过期或无效，需要：
1. 清除本地 token
2. 跳转到登录页面重新登录

---

## 四、小程序端需要修改的代码位置

### 1. API 配置文件
**需要修改：**
- API 基础 URL
- 所有接口路径（将 `/api/v1/miniprogram` 替换为 `/api/v1/client`）

**示例修改：**
```javascript
// 原配置
const BASE_URL = 'https://api.example.com';
const API_PREFIX = '/api/v1/miniprogram';

// 新配置
const BASE_URL = 'https://api.example.com';
const API_PREFIX = '/api/v1/client';  // 变更：miniprogram -> client

// 接口路径
const LOGIN_URL = `${API_PREFIX}/auth/login`;
const PROJECTS_URL = `${API_PREFIX}/projects`;
const CREATION_URL = `${API_PREFIX}/creation`;  // 变更：generate -> creation
const TIKHUB_URL = `${API_PREFIX}/tikhub`;
```

### 2. 请求拦截器
**需要修改：**
- 统一添加 `Authorization` header
- 统一处理响应格式（从 `response.data` 中提取实际数据）

**示例修改：**
```javascript
// uni.request 拦截器示例
const request = (options) => {
  // 添加 token
  const token = uni.getStorageSync('token');
  if (token) {
    options.header = options.header || {};
    options.header['Authorization'] = `Bearer ${token}`;
  }
  
  // 统一处理响应
  return new Promise((resolve, reject) => {
    uni.request({
      ...options,
      success: (res) => {
        // 统一响应格式处理
        if (res.statusCode === 200) {
          // 登录接口特殊处理（不使用统一格式）
          if (options.url.includes('/auth/login')) {
            if (res.data.success) {
              resolve(res.data);  // 直接返回 LoginResponse
            } else {
              reject(new Error('登录失败'));
            }
          } else if (res.data.code === 200) {
            resolve(res.data.data);  // 返回 data 字段
          } else if (res.data.code === 401) {
            // token 过期，跳转登录
            uni.removeStorageSync('token');
            uni.reLaunch({ url: '/pages/login/login' });
            reject(new Error(res.data.msg));
          } else {
            reject(new Error(res.data.msg || '请求失败'));
          }
        } else {
          reject(new Error('网络错误'));
        }
      },
      fail: reject
    });
  });
};
```

### 3. 登录相关页面
**需要修改：**
- 登录接口路径：`/api/v1/client/auth/login`
- 响应数据提取（登录接口直接返回 `LoginResponse`，不使用统一格式包装）

**示例修改：**
```javascript
// 登录函数
async function handleLogin() {
  const loginRes = await uni.login();
  const code = loginRes.code;
  
  try {
    const res = await uni.request({
      url: 'https://your-domain.com/api/v1/client/auth/login',  // 路径变更
      method: 'POST',
      data: { code },
      header: {
        'Content-Type': 'application/json'
      }
    });
    
    // 登录接口：直接返回 LoginResponse，不使用统一格式包装
    if (res.statusCode === 200 && res.data.success) {
      const token = res.data.token;  // token 在根级别
      const userInfo = res.data.userInfo;
      
      // 存储 token
      uni.setStorageSync('token', token);
      uni.setStorageSync('userInfo', userInfo);
      
      // 跳转
      uni.switchTab({ url: '/pages/index/index' });
    } else {
      uni.showToast({ title: '登录失败', icon: 'none' });
    }
  } catch (error) {
    uni.showToast({ title: error.message || '登录失败', icon: 'none' });
  }
}
```

### 4. 项目管理页面
**需要修改：**
- 所有项目相关接口路径：`/api/v1/client/projects/*`
- 响应数据提取（从 `response.data` 中获取）

### 5. 内容生成页面
**需要修改：**
- 生成接口路径：从 `/generate` 变更为 `/creation`
  - `GET /api/v1/client/creation/agents` - 获取智能体列表
  - `POST /api/v1/client/creation/chat` - 对话式生成
  - `POST /api/v1/client/creation/chat/quick` - 快速生成（使用 Query 参数）
- 请求参数格式（注意快速生成接口使用 Query 参数）
- 响应数据处理

**快速生成接口示例：**
```javascript
// 快速生成接口使用 Query 参数
uni.request({
  url: 'https://your-domain.com/api/v1/client/creation/chat/quick',
  method: 'POST',
  data: {
    content: '创作主题',
    agent_type: 'efficient_oral',
    project_id: 1,
    model_type: 'deepseek'
  },
  header: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
```

### 6. 抖音分析页面
**需要修改：**
- 分析接口路径：`/api/v1/client/tikhub/analyze-douyin`
- 请求参数：`url` 字段（不是 `account_url`）
- 响应数据提取

---

## 五、路径变更汇总表

| 功能模块 | 旧路径 | 新路径 | 变更说明 |
|---------|--------|--------|----------|
| 基础前缀 | `/api/v1/miniprogram` | `/api/v1/client` | 前缀变更 |
| 登录 | `/api/v1/miniprogram/auth/login` | `/api/v1/client/auth/login` | 前缀变更 |
| 用户信息 | `/api/v1/miniprogram/auth/user` | `/api/v1/client/auth/user` | 前缀变更 |
| 项目列表 | `/api/v1/miniprogram/projects` | `/api/v1/client/projects` | 前缀变更 |
| 内容生成 | `/api/v1/miniprogram/generate/*` | `/api/v1/client/creation/*` | 前缀+路径变更 |
| 抖音分析 | `/api/v1/miniprogram/tikhub/*` | `/api/v1/client/tikhub/*` | 前缀变更 |

---

## 六、常见问题处理

### 1. 响应数据嵌套问题
**问题：** 接口返回的数据被嵌套在 `data` 字段中，需要多一层访问。

**解决方案：** 在请求拦截器中统一处理，直接从 `response.data` 提取 `data` 字段返回。

**例外：** 登录接口（`/auth/login`）不使用统一格式，直接返回 `LoginResponse`。

### 2. Token 格式问题
**问题：** 请求头中 token 格式不正确。

**正确格式：** `Authorization: Bearer <token>`
- `Bearer` 和 token 之间必须有空格
- `Bearer` 首字母大写，其余小写

### 3. 跨域问题
**问题：** 小程序请求时出现跨域错误。

**解决方案：** 
- 确认后端已配置 CORS
- 在小程序管理后台配置服务器域名白名单

### 4. 404 错误
**问题：** 接口返回 404。

**检查清单：**
- ✅ API 基础路径是否正确（`/api/v1/client`）
- ✅ 接口路径是否完整
- ✅ HTTP 方法是否正确（GET/POST/PUT/DELETE）
- ✅ 后端服务是否正常运行

### 5. 内容生成接口路径混淆
**问题：** 内容生成接口路径从 `/generate` 变更为 `/creation`，容易混淆。

**解决方案：** 
- 统一使用 `/api/v1/client/creation/*` 作为内容生成接口路径
- 在代码中定义常量避免硬编码

---

## 七、测试 Checklist

在修改完成后，请测试以下功能：

- [ ] 微信登录功能正常
- [ ] Token 存储和读取正常
- [ ] 所有接口请求头中正确携带 token
- [ ] 401 错误时正确跳转登录页
- [ ] 项目列表获取正常
- [ ] 项目创建/编辑/删除正常
- [ ] 项目切换功能正常
- [ ] 智能体列表获取正常
- [ ] 内容生成功能正常（流式和非流式）
- [ ] 快速生成功能正常（Query 参数）
- [ ] 抖音分析功能正常
- [ ] 错误提示信息显示正常
- [ ] 响应数据正确解析和显示

---

## 八、快速迁移示例

### 原代码示例
```javascript
// 原登录接口
uni.request({
  url: 'https://api.example.com/api/v1/miniprogram/auth/login',
  method: 'POST',
  data: { code },
  success: (res) => {
    if (res.data.success) {
      const token = res.data.token;
      uni.setStorageSync('token', token);
    }
  }
});

// 原内容生成接口
uni.request({
  url: 'https://api.example.com/api/v1/miniprogram/generate/chat',
  method: 'POST',
  data: { messages, agent_type, model_type },
  success: (res) => {
    if (res.data.code === 200) {
      const content = res.data.data.content;
    }
  }
});
```

### 新代码示例
```javascript
// 新登录接口（路径变更）
uni.request({
  url: 'https://api.example.com/api/v1/client/auth/login',  // 路径变更
  method: 'POST',
  data: { code },
  header: {
    'Content-Type': 'application/json'
  },
  success: (res) => {
    // 登录接口直接返回 LoginResponse，不使用统一格式
    if (res.data.success) {
      const token = res.data.token;  // token 在根级别
      uni.setStorageSync('token', token);
    } else {
      uni.showToast({ title: '登录失败', icon: 'none' });
    }
  }
});

// 新内容生成接口（路径变更：generate -> creation）
uni.request({
  url: 'https://api.example.com/api/v1/client/creation/chat',  // 路径变更
  method: 'POST',
  data: { messages, agent_type, model_type, stream: false },
  header: {
    'Authorization': `Bearer ${uni.getStorageSync('token')}`,
    'Content-Type': 'application/json'
  },
  success: (res) => {
    if (res.data.code === 200) {
      const content = res.data.data.content;  // 注意：多了一层 data
    } else {
      uni.showToast({ title: res.data.msg, icon: 'none' });
    }
  }
});
```

---

## 九、API 路径常量定义建议

建议在项目中定义统一的 API 路径常量，避免硬编码：

```javascript
// api/config.js
const API_BASE_URL = 'https://your-domain.com';
const API_PREFIX = '/api/v1/client';

export const API_PATHS = {
  // 认证
  AUTH: {
    LOGIN: `${API_PREFIX}/auth/login`,
    USER: `${API_PREFIX}/auth/user`
  },
  // 项目
  PROJECTS: {
    LIST: `${API_PREFIX}/projects`,
    CREATE: `${API_PREFIX}/projects`,
    ACTIVE: `${API_PREFIX}/projects/active`,
    SWITCH: `${API_PREFIX}/projects/switch`,
    OPTIONS: `${API_PREFIX}/projects/options`,
    DETAIL: (id) => `${API_PREFIX}/projects/${id}`,
    UPDATE: (id) => `${API_PREFIX}/projects/${id}`,
    DELETE: (id) => `${API_PREFIX}/projects/${id}`
  },
  // 内容生成
  CREATION: {
    AGENTS: `${API_PREFIX}/creation/agents`,
    CHAT: `${API_PREFIX}/creation/chat`,
    QUICK: `${API_PREFIX}/creation/chat/quick`
  },
  // 抖音分析
  TIKHUB: {
    ANALYZE: `${API_PREFIX}/tikhub/analyze-douyin`
  }
};
```

---

## 十、联系支持

如有问题，请检查：
1. 后端日志中的错误信息
2. 小程序开发者工具的网络请求详情
3. 后端 API 文档：`http://your-domain.com/docs`

---

**文档版本：** v2.0  
**最后更新：** 2024-12-XX  
**主要变更：**
- API 路径前缀从 `/api/v1/miniprogram` 变更为 `/api/v1/client`
- 内容生成接口路径从 `/generate` 变更为 `/creation`
- 更新了所有接口路径和示例代码
